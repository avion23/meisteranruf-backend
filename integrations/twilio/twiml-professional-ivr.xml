<?xml version="1.0" encoding="UTF-8"?>
<TwiML xmlns="http://twilio.com/xml/robot">

  <Template id="professional-customer-welcome">
    <Response>
      <Gather action="{{callbackUrl}}/customer-gather" method="POST" numDigits="1" timeout="10">
        <Say language="de-DE" voice="alice">
          Guten Tag. Vielen Dank für Ihren Anruf bei {{companyName}}.
          Für eine persönliche Beratung ist unser Meisterbetrieb erreichbar unter der Nummer {{installerPhone}}.
          Drücken Sie 1, wenn Sie eine Nachricht hinterlassen möchten.
          Ich rufe Sie innerhalb von 2 Stunden zurück.
        </Say>
      </Gather>
      <Redirect method="POST">{{callbackUrl}}/customer-message</Redirect>
    </Response>
  </Template>

  <Template id="customer-message-recording">
    <Response>
      <Say language="de-DE" voice="alice">
        Bitte hinterlassen Sie eine Nachricht mit Ihrer Adresse und Ihrem Anliegen.
        Nennen Sie auch Ihre Telefonnummer, damit ich Sie zurückrufen kann.
        Sprechen Sie bitte nach dem Signal.
      </Say>
      <Record 
        action="{{callbackUrl}}/message-recorded" 
        method="POST" 
        maxLength="120" 
        timeout="10"
        recordingStatusCallback="{{callbackUrl}}/recording-status"
        recordingStatusCallbackEvent="completed in-progress failed"
        transcribe="true" 
        transcribeCallback="{{callbackUrl}}/transcribe">
      </Record>
    </Response>
  </Template>

  <Template id="message-recorded-confirmation">
    <Response>
      <Say language="de-DE" voice="alice">
        Vielen Dank für Ihre Nachricht.
        Ich habe sie aufgezeichnet und kümmere mich um Ihr Anliegen.
        Sie können mich auch per WhatsApp unter der Nummer {{whatsappNumber}} erreichen.
        Einen schönen Tag noch.
      </Say>
      <Hangup/>
    </Response>
  </Template>

  <Template id="customer-gather-1">
    <Response>
      <Say language="de-DE" voice="alice">
        Sie haben 1 gewählt. Bitte hinterlassen Sie eine Nachricht mit Ihrer Adresse und Ihrem Anliegen.
      </Say>
      <Record 
        action="{{callbackUrl}}/message-recorded" 
        method="POST" 
        maxLength="120" 
        timeout="10"
        transcribe="true" 
        transcribeCallback="{{callbackUrl}}/transcribe">
      </Record>
    </Response>
  </Template>

  <Template id="transcription-received">
    <Response>
      <Say language="de-DE" voice="alice">
        Vielen Dank für Ihre Nachricht.
        Ich habe sie aufgezeichnet und leite sie an unseren Meisterbetrieb weiter.
        Sie erhalten innerhalb von 2 Stunden einen Rückruf.
        Einen schönen Tag noch.
      </Say>
      <Hangup/>
    </Response>
  </Template>

  <Template id="installer-welcome">
    <Response>
      <Gather action="{{callbackUrl}}/gather" method="POST" numDigits="1" timeout="10">
        <Say language="de-DE" voice="alice">
          Guten Tag. Hier ist eine neue Anfrage für Sie.
          Kunde: {{customerName}}.
          Adresse: {{address}}.
          Auftragsart: {{leadType}}.
          Drücken Sie 1, um den Kunden direkt zu verbinden.
          Drücken Sie 2, um später zurückzurufen.
        </Say>
      </Gather>
      <Pause length="2"/>
      <Redirect method="POST">{{callbackUrl}}/timeout</Redirect>
    </Response>
  </Template>

  <Template id="dtmf-response-1">
    <Response>
      <Say language="de-DE" voice="alice">
        Vielen Dank. Sie werden nun mit dem Kunden verbunden.
      </Say>
      <Dial callerId="{{callerId}}" action="{{callbackUrl}}/call-complete" method="POST">
        {{customerNumber}}
      </Dial>
    </Response>
  </Template>

  <Template id="dtmf-response-2">
    <Response>
      <Say language="de-DE" voice="alice">
        Danke. Wir haben vermerkt, dass Sie später zurückrufen werden.
        Die Kundendaten wurden Ihnen per SMS zugesendet.
      </Say>
      <Hangup/>
    </Response>
  </Template>

  <Template id="dtmf-invalid">
    <Response>
      <Say language="de-DE" voice="alice">
        Ungültige Eingabe. Bitte versuchen Sie es erneut.
      </Say>
      <Redirect method="POST">{{callbackUrl}}/welcome</Redirect>
    </Response>
  </Template>

  <Template id="installer-timeout">
    <Response>
      <Say language="de-DE" voice="alice">
        Wir haben keine Eingabe erhalten.
        Die Kundendaten werden Ihnen per SMS gesendet.
      </Say>
      <Hangup/>
    </Response>
  </Template>

  <Template id="call-completed">
    <Response>
      <Say language="de-DE" voice="alice">
        Das Gespräch ist beendet. Vielen Dank und einen schönen Tag.
      </Say>
      <Hangup/>
    </Response>
  </Template>

  <Template id="voicemail-fallback">
    <Response>
      <Say language="de-DE" voice="alice">
        Der Kunde ist nicht erreichbar.
        Sie können jetzt eine Nachricht hinterlassen.
      </Say>
      <Record action="{{callbackUrl}}/voicemail-complete" method="POST" maxLength="60" transcribe="true" transcribeCallback="{{callbackUrl}}/transcribe">
        <Say language="de-DE" voice="alice">
          Hinterlassen Sie bitte eine Nachricht nach dem Ton.
        </Say>
      </Record>
    </Response>
  </Template>

  <Template id="voicemail-complete">
    <Response>
      <Say language="de-DE" voice="alice">
        Danke für Ihre Nachricht. Wir haben sie gespeichert und senden sie dem Kunden zu.
      </Say>
      <Hangup/>
    </Response>
  </Template>

  <Template id="call-failed">
    <Response>
      <Say language="de-DE" voice="alice">
        Entschuldigung, es ist ein Fehler aufgetreten.
        Wir senden Ihnen die Kundendaten per SMS.
      </Say>
      <Hangup/>
    </Response>
  </Template>

  <Template id="retry">
    <Response>
      <Say language="de-DE" voice="alice">
        Versuch {{attempt}} von {{maxAttempts}}.
      </Say>
      <Gather action="{{callbackUrl}}/gather" method="POST" numDigits="1" timeout="8">
        <Say language="de-DE" voice="alice">
          Drücken Sie 1, um den Kunden zu verbinden.
          Drücken Sie 2 für Rückruf später.
        </Say>
      </Gather>
      <Pause length="1"/>
      <Redirect method="POST">{{callbackUrl}}/timeout</Redirect>
    </Response>
  </Template>

  <Template id="test-greeting">
    <Response>
      <Say language="de-DE" voice="alice">
        Testanruf erfolgreich. Das Twilio System ist betriebsbereit.
      </Say>
      <Hangup/>
    </Response>
  </Template>

</TwiML>
